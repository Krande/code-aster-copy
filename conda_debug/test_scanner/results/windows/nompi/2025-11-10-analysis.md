# Code_Aster MSVC Windows Test Results Analysis
Date: 2025-11-10

## Overall Statistics
- **Total Tests**: 2,275
- **Passing Tests**: 406 (17.85%)
- **Failed Tests**: 1,869 (82.15%)

## Fixed Issues
✅ **OverflowError in run_aster**: Fixed the `OverflowError: can't convert negative int to unsigned` error by ensuring Windows always uses the custom `_waitstatus_to_exitcode` function.

## Top Failure Categories

### 1. MODI_MAILLAGE_WIN_FATAL - 379 tests (20.28%)
**Description**: Access violations in mesh modification operations
**Impact**: Critical - affects all mesh transformation operations
**Root Cause**: Likely memory management issues in Fortran/C interface for mesh operations

**Affected Operations**: 
- Mesh refinement
- Mesh transformation
- Contact surface preparation

### 2. Unknown - 457 tests (24.45%)
**Description**: Tests with unclassified error patterns
**Impact**: High - needs investigation to categorize
**Note**: Many appear to be in thermal, dynamics, and specialized analysis domains

**Sample categories**:
- Thermal analysis (tpla*, tpll*, tplp*, tpls*, tplv*, tpna*, tpnl*, tpnv*)
- Thermal-mechanics coupling (ttla*, ttll*, ttlp*, ttlv*, ttna*, ttnl*, ttnp*)
- Dynamic vibration (adlv*, ahlv*, fdlv*, fdll*, sdl*)

### 3. STAT_NON_LINE_WIN_FATAL - 370 tests (19.80%)
**Description**: Access violations in non-linear static analysis
**Impact**: Critical - non-linear analysis is core functionality
**Root Cause**: Likely issues in:
- Iterative solver loops
- Convergence checking
- Material behavior laws (UMAT integration)

### 4. MECA_STATIQUE_WIN_FATAL - 284 tests (15.20%)
**Description**: Access violations in linear static analysis
**Impact**: Critical - basic structural analysis
**Root Cause**: Issues in:
- Matrix assembly
- Linear solver calls (MUMPS integration)
- Result computation

### 5. POST_ELEM_WIN_FATAL - 89 tests (4.76%)
**Description**: Access violations in post-processing operations
**Impact**: Medium - affects result extraction
**Root Cause**: Memory access issues when extracting:
- Element forces
- Energy calculations
- Derived quantities

### 6. JEVEUX1_55 Errors - 144 tests (7.71% total)
**Description**: JEVEUX memory manager errors across multiple operations
**Categories**:
- DEFI_GROUP: 52 tests (2.78%)
- MODI_MAILLAGE: 20 tests (1.07%)
- AFFE_CHAR_CINE: 17 tests (0.91%)
- AFFE_CHAR_THER: 12 tests (0.64%)
- CREA_MAILLAGE: 12 tests (0.64%)
- CALC_MATE_HOMO: 12 tests (0.64%)
- AFFE_MODELE: 9 tests (0.48%)
- AFFE_CHAR_MECA: 8 tests (0.43%)
- Others: 2 tests

**Impact**: High - JEVEUX is the core data structure manager
**Root Cause**: Fundamental memory management issues in the JEVEUX system

### 7. MED/HDF5 Issues - 58 tests (3.10%)
- MED_ACCESS_ERROR: 43 tests (2.30%) - File I/O crashes
- MED_57_RESU_READ_MED_F90: 13 tests (0.70%) - Fortran MED reading
- MED_18_SANS_PARTITIONNEUR: 2 tests (0.11%)

**Impact**: Medium - affects file I/O
**Root Cause**: Issues with MED/HDF5 library integration

### 8. LIRE_RESU_WIN_FATAL - 34 tests (1.82%)
**Description**: Crashes when reading result files
**Impact**: Medium - affects restart capability

## Categories by Severity

### CRITICAL (Core Functionality Broken)
1. **MODI_MAILLAGE_WIN_FATAL** - 379 tests
2. **STAT_NON_LINE_WIN_FATAL** - 370 tests  
3. **MECA_STATIQUE_WIN_FATAL** - 284 tests
4. **Unknown (likely critical)** - 457 tests

**Total Critical**: ~1,490 tests (79.7% of failures)

### HIGH (Important Features)
1. **JEVEUX1_55 errors** - 144 tests
2. **POST_ELEM_WIN_FATAL** - 89 tests
3. **MED file issues** - 58 tests
4. **LIRE_RESU_WIN_FATAL** - 34 tests

**Total High**: 325 tests (17.4% of failures)

### MEDIUM (Specific Features)
1. **CALC_MATE_HOMO_ACCESS_ERROR** - 12 tests
2. **CALC_ESSAI_GEOMECA errors** - 6 tests
3. **SIMU_POINT_MAT errors** - 5 tests
4. **FACTOR_11 errors** - 4 tests
5. **REST_SPEC_PHYS** - 3 tests

**Total Medium**: 30 tests (1.6% of failures)

### LOW (Minor Issues)
1. **DEFI_BASE_REDUITE_WIN_FATAL** - 2 tests
2. **MISSING_XMGRACE** - 2 tests (expected on Windows)
3. **MISSING_ASRUN** - 2 tests
4. **NOOK_TEST_RESU** - 2 tests
5. **Various single-test failures** - ~10 tests

**Total Low**: ~20 tests (1.1% of failures)

## Root Cause Analysis

### Primary Issues

#### 1. **Fortran/C/C++ ABI Incompatibility** (Most Likely)
- **Symptoms**: Systematic crashes across all major operations
- **Evidence**: 
  - Crashes happen at Python→C/Fortran boundary
  - Affects both simple (MECA_STATIQUE) and complex (STAT_NON_LINE) operations
  - No specific error messages, just access violations
- **Possible Causes**:
  - Intel Fortran (ifx) calling convention mismatches with MSVC C/C++
  - Name mangling issues between languages
  - Stack alignment problems (MSVC requires 16-byte alignment)
  - Struct packing/alignment differences

#### 2. **JEVEUX Memory Manager Issues**
- **Symptoms**: JEVEUX1_55 errors in multiple operations
- **Evidence**: Affects fundamental operations like AFFE_*, DEFI_*, CREA_*
- **Possible Causes**:
  - Pointer size assumptions (32-bit vs 64-bit)
  - Memory allocation strategy incompatible with Windows heap
  - Endianness or data structure padding issues

#### 3. **Symbol Export Problems**
- **Symptoms**: Access violations when calling Fortran/C functions
- **Evidence**: Crashes at function boundaries
- **Possible Causes**:
  - Incomplete .def files
  - Wrong symbol names in exports
  - Missing redirect modules in msvc/c_entrypoints

#### 4. **Library Integration Issues**
- **Symptoms**: MED file access errors, MUMPS solver issues
- **Evidence**: Specific failures with external libraries
- **Possible Causes**:
  - Dependency libraries built with different toolchain
  - ABI incompatibility with external libraries
  - Integer size mismatches (INT32 vs INT64)

## Recommended Action Plan

### Immediate Actions (Fix Category 1-3)

#### Phase 1: Verify Symbol Exports
```cmd
pixi run def-bibfor
pixi run def-bibcpp
```
- Regenerate all .def files
- Verify all critical symbols are exported
- Check for name mangling issues

#### Phase 2: Test Minimal Case
1. Identify simplest failing test (e.g., ssll100b or ssls100a)
2. Build with debug symbols
3. Run under debugger (WinDbg or Visual Studio debugger)
4. Identify exact function call that crashes
5. Examine calling convention and parameters

#### Phase 3: Check Fortran Interface
1. Review `msvc/c_entrypoints` redirect modules
2. Verify all Fortran entry points have correct signatures
3. Check calling conventions (stdcall vs cdecl)
4. Validate parameter passing (by value vs by reference)

#### Phase 4: JEVEUX Investigation
1. Enable JEVEUX debug mode
2. Test memory allocation/deallocation patterns
3. Check pointer arithmetic in JEVEUX core
4. Verify 64-bit integer handling throughout

### Medium-Term Actions

#### Fix Library Integration
1. Rebuild all dependencies (MUMPS, METIS, HDF5, MED) with MSVC
2. Ensure consistent INT64 usage
3. Verify ABI compatibility
4. Test each library independently

#### Improve Testing Infrastructure
1. Create minimal reproducer tests
2. Add unit tests for Fortran/C interface
3. Implement automated crash reporting
4. Set up continuous integration with crash analysis

### Long-Term Actions

#### Code Modernization
1. Review and update calling conventions
2. Add explicit interface declarations
3. Improve error handling at language boundaries
4. Document ABI requirements

#### Platform Support
1. Create Windows-specific code paths where needed
2. Add platform-specific tests
3. Document Windows limitations
4. Improve MSVC compatibility layer

## Success Metrics

### Short-term (1-2 months)
- [ ] Reduce failures by 50% (down to ~900 failing tests)
- [ ] Eliminate all JEVEUX1_55 errors
- [ ] Fix MECA_STATIQUE_WIN_FATAL category

### Medium-term (3-6 months)
- [ ] Achieve 50% pass rate (1,137+ passing tests)
- [ ] Fix all critical categories (MODI_MAILLAGE, STAT_NON_LINE)
- [ ] Stabilize MED file I/O

### Long-term (6-12 months)
- [ ] Achieve 80%+ pass rate (1,820+ passing tests)
- [ ] Categorize all "Unknown" failures
- [ ] Ready for conda-forge distribution

## Notes

1. The current 17.85% pass rate is actually encouraging for early-stage MSVC porting
2. Many failures appear systemic (same root cause) - fixing one may fix many
3. Priority should be on fixing the Fortran/C ABI issues first
4. Consider engaging with Intel Fortran and Microsoft support teams
5. May need to adjust build flags for better ABI compatibility

## Key Files to Investigate

1. `msvc/c_entrypoints/*.cpp` - Redirect modules
2. `bibfor/` - Fortran source
3. `bibcxx/` - C++ interfaces  
4. `msvc/scripts/def_*.py` - Symbol export scripts
5. JEVEUX memory manager source files
6. Build configuration in `wscript` and `msvc/scripts/conda_manual_build.bat`

