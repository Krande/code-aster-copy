[project]
name = "code-aster"
version = "17.2.0"
description = "A pixi project for building the windows variant of code aster"
channels = ["conda-forge"]
platforms = ["win-64", "linux-64"]

[environments]
local = ["local"]
local-win = ["local-win", "local"]
local-unix = ["local-unix", "local"]
conda-unix = ["conda-unix"]
conda-win = ["conda-win"]

[feature.local]
platforms = ["win-64", "linux-64"]

[feature.conda-unix]
channels = ["conda-forge"]
platforms = ["linux-64"]
dependencies = { rattler-build = "*" }

[feature.conda-win]
channels = ["https://repo.prefix.dev/code-aster", "conda-forge"]
platforms = ["win-64"]
dependencies = { rattler-build = "*" }

[feature.local-win]
channels = ["https://repo.prefix.dev/code-aster", "conda-forge"]
platforms = ["win-64"]

[feature.local-unix]
channels = ["conda-forge"]
platforms = ["linux-64"]

[feature.local.dependencies]
python = "3.12.8"
libboost-devel = "1.84"
waf = "2.0.27"
numpy = "1.26"
pyyaml = "*"
pytest = "*"
python-dotenv = "*"
pybind11 = "2.13.1"
setuptools = "*"

[feature.local-unix.dependencies]
gfortran = "13*"
gcc = "13*"

[feature.local-win.dependencies]
vswhere = "*"
libblas = { version = "*", build = "*mkl" }
liblapack = { version = "*", build = "*mkl" }
mkl-devel = "2024.1"
intel-fortran-rt = "2024.1"
cmake = "*"
ninja = "*"
psutil = "*"
clang = "18*"
mfront = { version = "*", channel="conda-forge" }
mgis = { version = "*", channel="conda-forge" }
libmed = { version = "*", build = "*debug*" }
medcoupling = { version = "*", build = "*debug*" }
scotch = { version = "*", build = "*debug*" }
metis = { version = "*", build = "*debug*" }
mumps = { version = "*", build = "*debug*" }

[feature.conda-win.tasks]
cbuild = {cmd = ["rattler-build", "build","-r", "conda/recipe.yaml", "-c", "conda-forge", "-c", "https://repo.prefix.dev/code-aster"] }
[feature.conda-unix.tasks]
cbuildn = {cmd = ["rattler-build", "build","-r", "conda/recipe.yaml"] }
cbuild = {cmd = ["rattler-build", "build","-r", "conda/recipe.yaml", "-c", "https://repo.prefix.dev/code-aster", "-c", "conda-forge"] }
ctest = {cmd = ["rattler-build", "test"]}

[feature.local-unix.tasks]
build = { cmd = ["waf", "configure", "build"], description = "Build the project" }

[feature.local-win.tasks]
build = { cmd = ["msvc/scripts/conda_manual_build.bat", "--pixi-build"], description = "Build the project", env = { INTEL_VARS_PATH="C:/Program Files (x86)/Intel/oneAPI/compiler/latest/env" } }
install = {cmd=["msvc/scripts/conda_rearrange.bat"], description="Copy the latest build files to their respective locations"}
test = { cmd = [
    "run_ctest",
    "--resutest=temp\\seq",
    "-L", "submit",
    "-L", "sequential",
    "-LE", "need_data",
    "--timefactor=5.0",
    "--only-failed-results"] , description = "Run the default sequential tests" }
test_scan = { cmd = ["python", "conda/test_scanner/eval_tests.py", "--output", "conda/test_scanner/results"], description = "Scan the test results" }
debug = { cmd = ["python", "conda/scripts/run_tests.py", "--test-file", "comp008b"], description = "Run the debug script on a specific test" }
run_aster = { cmd = ["run_aster.bat"], description = "Run the aster executable (code aster needs to be built and installed)" }

dumpbin = { cmd = ["dumpbin",], description = "Dump the dependencies of the aster executable" }
bibcxx_cc = { cmd = [
    "cmake", "-B", "build-cmake", "-G", "Ninja",
    "-DBUILD_BIBCXX=ON",
    "-DWIN32_LEAN_AND_MEAN=ON",
    "-DCMAKE_BUILD_TYPE=release",
    "--fresh"
], description = "Configure the project for building bibcxx", env = { CC = "clang-cl", CXX = "clang-cl" } }
bibcxx_ci = { cmd = ["ninja", "-C", "build-cmake"], description = "Build bibcxx", depends_on = ["bibcxx_cc"] }

bibfor_cmake_configure = { cmd = [
    "cmake", "-B", "build-cmake", "-G", "Ninja",
    "-DBUILD_BIBFOR=ON",
    "-DWIN32_LEAN_AND_MEAN=ON",
    "-DCMAKE_BUILD_TYPE=release",
    "--fresh"
], description = "Configure the project for building bibfor", env = { FC = "ifx.exe", CC = "clang-cl", CXX = "clang-cl" } }
cmake_bibfor = { cmd = ["ninja", "-C", "build-cmake"], description = "Build bibfor", depends_on = ["bibfor_cmake_configure"] }

[feature.local-win.target.win-64.activation]
scripts = ["msvc/scripts/activate.bat", "msvc/scripts/activate_intel.bat"]